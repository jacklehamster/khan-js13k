function r(t){const n=new Array(Math.ceil(t.length*2));for(let e=0;e<t.length;e++){n[e*2]=t[e]%16;n[e*2+1]=(t[e]>>4)%16}return n}function i(e){const t=[0,0];let n=0,o=0;do{n=e.pop()-7;o=e.pop()-7;t[0]+=n;t[1]+=o}while(n||o);let r,i;do{n=e.pop()-7;o=e.pop()-7;if(n||o){const a=r*o;const s=i*n;if(Math.abs(a-s)<5){t[t.length-2]+=n;t[t.length-1]+=o}else{t.push(t[t.length-2]+n,t[t.length-1]+o)}r=n;i=o}}while(n||o);return t}function a(t,n){const o=new Array(t.pop());for(let e=0;e<o.length;e++){o[e]=i(t).map(e=>e*n)}return o}function s(t){const n=t.pop();const o=[];for(let e=0;e<n;e++){const r=t.pop()+(t.pop()<<4);o.push(String.fromCharCode(r))}return o.join("")}function l(t,n){const o=new Array(t.pop());for(let e=0;e<o.length;e++){o[e]={};o[e].name=s(t);o[e].lines=a(t,n);o[e].anim=t.pop();const r=t.pop();o[e].hidden=r===1}return o}function c(t){const n=new Array(t.pop());for(let e=0;e<n.length;e++){n[e]=s(t)}return n}function M1(e){const t=r(e);const n={};console.log(t);t.reverse();const o=t.pop();n.animations=c(t);console.log(t.reverse());t.reverse();n.shapes=l(t,o);return n}"use strict";var t=function(){var Y=function(e){return Math.sin(e*6.283184)};var e=function(e){return 2*(e%1)-1};var t=function(e){return e%1<.5?1:-1};var n=function(e){var t=e%1*4;if(t<2)return t-1;return 3-t};var S=function(e){return.003959503758*2**((e-128)/12)};var j=function(e,t,n){var o=K[e.i[0]],r=e.i[1],i=e.i[3]/32,a=K[e.i[4]],s=e.i[5],l=e.i[8]/32,c=e.i[9],d=e.i[10]*e.i[10]*4,h=e.i[11]*e.i[11]*4,f=e.i[12]*e.i[12]*4,u=1/f,y=-e.i[13]/16,m=e.i[14],p=n*2**(2-e.i[15]);var x=new Int32Array(d+h+f);var g=0,M=0;var v,w,b,C,$,L,A;for(v=0,w=0;v<d+h+f;v++,w++){if(w>=0){m=m>>8|(m&255)<<4;w-=p;L=S(t+(m&15)+e.i[2]-128);A=S(t+(m&15)+e.i[6]-128)*(1+8e-4*e.i[7])}b=1;if(v<d){b=v/d}else if(v>=d+h){b=(v-d-h)*u;b=(1-b)*3**(y*b)}g+=L*b**i;$=o(g)*r;M+=A*b**l;$+=a(M)*s;if(c){$+=(2*Math.random()-1)*c}x[v]=80*$*b|0}return x};var K=[Y,t,e,n];var N,U,_,G,z;this.init=function(e){N=e;U=e.endPattern;_=0;G=e.rowLen*e.patternLen*(U+1)*2;z=new Int32Array(G)};this.generate=function(){var e,t,I,n,o,r,i,a,s,l,D,H,R,c,d,h,B;var f=new Int32Array(G),u=N.songData[_],y=N.rowLen,m=N.patternLen;var p=0,x=0,g;var M,v=false;var w=[];for(n=0;n<=U;++n){a=u.p[n];for(o=0;o<m;++o){var b=a?u.c[a-1].f[o]:0;if(b){u.i[b-1]=u.c[a-1].f[o+m]||0;if(b<17){w=[]}}var C=K[u.i[16]],$=u.i[17]/512,L=2**(u.i[18]-9)/y,A=u.i[19],S=u.i[20],T=u.i[21]*43.23529*3.141592/44100,k=1-u.i[22]/255,E=u.i[23]*1e-5,O=u.i[24]/32,P=u.i[25]/512,X=6.283184*2**(u.i[26]-9)/y,W=u.i[27]/255,q=u.i[28]*y&~1;d=(n*m+o)*y;for(r=0;r<4;++r){i=a?u.c[a-1].n[o+r*m]:0;if(i){if(!w[i]){w[i]=j(u,i,y)}var F=w[i];for(t=0,e=d*2;t<F.length;t++,e+=2){f[e]+=F[t]}}}for(t=0;t<y;t++){s=(d+t)*2;c=f[s];if(c||v){h=T;if(A){h*=C(L*s)*$+.5}h=1.5*Math.sin(h);p+=h*x;g=k*(c-x)-p;x+=h*g;c=S==3?x:S==1?g:p;if(E){c*=E;c=c<1?c>-1?Y(c*.25):-1:1;c/=E}c*=O;v=c*c>1e-5;l=Math.sin(X*s)*P+.5;M=c*(1-l);c*=l}else{M=0}if(s>=q){M+=f[s-q+1]*W;c+=f[s-q]*W}f[s]=M|0;f[s+1]=c|0;z[s]+=M|0;z[s+1]+=c|0}}}_++;return _/N.numChannels};this.createAudioBuffer=function(e){var t=e.createBuffer(2,G/2,44100);for(var n=0;n<2;n++){var o=t.getChannelData(n);for(var r=n;r<G;r+=2){o[r>>1]=z[r]/65536}}return t};this.createWave=function(){var e=44;var t=e+G*2-8;var n=t-36;var o=new Uint8Array(e+G*2);o.set([82,73,70,70,t&255,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,n&255,n>>8&255,n>>16&255,n>>24&255]);for(var r=0,i=e;r<G;++r){var a=z[r];a=a<-32767?-32767:a>32767?32767:a;o[i++]=a&255;o[i++]=a>>8&255}return o};this.getData=function(e,t){var n=2*Math.floor(e*44100);var o=new Array(t);for(var r=0;r<2*t;r+=1){var i=n+r;o[r]=e>0&&i<z.length?z[i]/32768:0}return o}};var v1={songData:[{i:[3,194,128,0,2,198,128,6,0,0,12,12,33,0,0,0,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[1,1,2,3,4,5,1,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,127,,130,127,,130,129,127,127,,130,127,,130,129,127],f:[]},{n:[125,,128,125,,128,127,125,125,,128,125,,128,127,125,122,,125,122,,125,123,122,123,,127,123,,127,125,123],f:[]},{n:[125,,123,122,,125,123,122,125,,123,122,,125,123,122,118,,115,118,,122,120,122,118,,115,118,,122,120,118],f:[]},{n:[],f:[]},{n:[135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,137,135,,135,134,132],f:[]},{n:[128,,132,128,,132,130,128,128,,132,128,,132,130,128,128,,132,128,,132,130,128,130,,134,130,,134,132,130],f:[]},{n:[130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,4,5,,2,3,4,5,,,6,7,8,9],c:[{n:[],f:[]},{n:[139,,,144,,,146,,147,,,146,,,144,,142,,,144,,,146,,139],f:[]},{n:[139,,,144,,,146,,147,,,146,,,147,,149,,,147,,,149,,151,,,,,,151],f:[]},{n:[152,,,154,,,151,,149,,,151,,,147,,146,,,142,,,146,,147],f:[]},{n:[149,,,146,,,149,,147,,,144,,,147,,146,,,142,,,144,,144],f:[]},{n:[,,,,139,,,,144,,139,,147,,,,144,,,,147,,144,,151,,,,147],f:[]},{n:[151,,147,,154,,,,142,,,,147,,142,,151,,,,,,142,,144,,140,,147],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,142,,144,,140,,147,,,,,,142,,144,,140,,149,,,,142,,,,147,,142],f:[]},{n:[151],f:[]}]},{i:[2,29,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,2,3,4,5,,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,,,,,,,,,,,,,,,132],f:[]},{n:[132,,,,,,,,,,,,,,,,130],f:[]},{n:[132,,,,,,,,,,,,,,,,135],f:[]},{n:[140,,,,,,,,,,,,,,,,137],f:[]},{n:[134,,,,,,,,,,,,,,,,132],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[134,,,,,,,,,,,,,,,,130],f:[]}]},{i:[0,255,117,64,0,255,110,0,64,0,4,6,35,0,0,0,0,0,0,0,2,14,0,1,39,76,5,0,0],p:[,1,1,1,1,1,1,1,1,1,1,,1,1,1,1,1],c:[{n:[135,,,,144,,,,135,,,,144,,,,135,,,,144,,,,135,,,,144,,144],f:[]}]},{i:[0,89,152,0,0,255,152,12,0,0,2,0,60,0,0,0,0,0,0,0,2,255,0,0,32,47,3,157,2],p:[,,,,,,,2,3,4,,5],c:[{n:[],f:[]},{n:[,,,,,,,,135,,,,,,,,134,,,,,,,,132,,,,130],f:[]},{n:[127,,,,,,,,,,,,135,,,,134,,,,132,,,,130],f:[]},{n:[132],f:[]},{n:[137,,,134,,,137,,135,,,132,,,135,,134,,,130,,,132,,132],f:[]}]}],rowLen:5513,patternLen:32,endPattern:16,numChannels:5};var e={songData:[{i:[2,24,128,0,3,27,128,0,0,0,0,6,29,0,0,0,0,195,4,1,3,50,184,119,244,147,6,84,6],p:[1,1,4,5,6,3,4,5,6,2,1,1,1,3,1,3],c:[{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,135,140,,139,137,135,140,,135,140,,139,137,135,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,139,140,,139,137,135,140,,139,140,,139,137,135,134,,130,134,,132,127,127,134,,127,134,,132,130,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,127,,130,129,,130,129,127,127,,130,130,,130,129,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,137,,135,137,,140,139,137,137,,135,137,,140,139,137],f:[]},{n:[135,,139,137,,139,137,135,135,,139,137,,139,137,135,140,,135,140,,139,137,135,140,,135,140,,139,137,135],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,6,7,2,3,6,1,,4,5,8,9,10],c:[{n:[140,,139,,137,,135,,134,,,,,,132,,132],f:[]},{n:[132,134,135,134,132,,,,,,,,134,,,,130,,,,127],f:[]},{n:[132,134,135,134,132,,,,,,134,,,,135,,137],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[139,,,,,,,,137,,,,,,,,135,,,,,,,,137],f:[]},{n:[135,137,139,137,135,,,,,,137,,,,139,,140,,,,135,,,,,,,,135],f:[]},{n:[140,,139,,137,,135,,137,,,,,,132,,134],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[142,,,,,,,,140,,,,,,,,135,,,,,,,,137],f:[]},{n:[139],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,1,2,3,4,1,2,3,5,1,1,2,3,1,4],c:[{n:[120,,,,120,,,,120,,,,120,,,,115,,,,115,,,,115,,,,115],f:[]},{n:[120,,,,120,,,,120,,,,120,,,,125,,,,125,,,,125,,,,125],f:[]},{n:[123,,,,123,,,,123,,,,123,,,,128,,,,128,,,,123,,,,123],f:[]},{n:[128,,,,123,,,,125,,,,123,,,,122,,,,115,,,,122,,,,115],f:[]},{n:[128,,,,123,,,,122,,,,115,,,,120,,,,120,,,,120,,,,120],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[,1,2,2,2,1,2,2,2,1,2,2,2,2,2,1],c:[{n:[118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,118,118,,,,,,,,119,,,,,,,,119,,,,,,,,119,,,,119],f:[]},{n:[111,,,,132,,,,111,,,,132,,,,111,,,,132,,,,111,,,,132,,132],f:[]}]},{i:[2,138,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,,,,,1,2,3,4,5,6],c:[{n:[120,,,,,,,,120,,,,,,,,115,,,,,,,,115],f:[]},{n:[120,,,,,,,,120,,,,,,,,125,,,,,,,,125],f:[]},{n:[123,,,,,,,,123,,,,,,,,128,,,,,,,,123],f:[]},{n:[125,,,,,,,,,,,,,,,,132,,,,,,,,132,,,,,,134],f:[]},{n:[119,,,,,,,,,,,,,,,,120,,,,,,,,120,,,,,,122],f:[]},{n:[119,,,,,,,,,,,,,,,,120],f:[]}]}],rowLen:4725,patternLen:32,endPattern:15,numChannels:5};class w1{constructor(e){this.player=new t;this.player.init(e);this.prepare()}prepare(){const n=setInterval(()=>{const e=this.player.generate();if(e>=1){clearInterval(n);var t=this.player.createWave();this.audio=document.createElement("audio");this.audio.src=URL.createObjectURL(new Blob([t],{type:"audio/wav"}));this.audio.loop=true}},0)}play(){this.audio?.play()}stop(){if(this.audio){this.audio?.pause();this.audio.currentTime=0}}}let b1=document.querySelector.bind(document);document.addEventListener("DOMContentLoaded",()=>{b1("body").style.backgroundColor="#100";b1("h3").style.opacity=1;setTimeout(()=>{let A=b1("canvas");let L=A.getContext("2d");let h=A.style;A.width=2e3;h.width=`${A.width/2}px`;A.height=1200;h.height=`${A.height/2}px`;h.border="1px solid black";h.backgroundColor="#efd";setTimeout(()=>h.opacity=1,1e3);const f=.75;const n={};document.addEventListener("keyup",e=>{delete n[e.code]});document.addEventListener("keydown",e=>{n[e.code]=true;e.preventDefault()});const y=[];const S=[0,0];let $=true;const u=new w1(v1);let c=0;let T=window.upgrades={bow:0,speedWhileShooting:0,speed:1,maxHealth:0,shield:0,quickShot:0,money:0,rickoShot:0,giantPiercing:0,treeNav:0,rage:0,control:3};const d=[()=>{},()=>{T.bow++;w=20;o.textContent=`Level ${l}\nWelcome`},()=>{o.textContent=`Level ${l}\nWelcome`;w=40;m+=.2},()=>{o.textContent=`Level ${l}\nWelcome`;w=60;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=80;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=100;m+=.1},()=>{o.textContent=`Level ${l}\n NOTE: This is the right level for story mode ending.`;w=150;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=200;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=300;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=400;m+=.1},()=>{o.textContent=`Level ${l}\nWelcome`;w=400;m+=.1},()=>{w=400;o.textContent=`Level ${l}\nYou've reached the last supported level.`;m+=.5}];let m=.7;const s=6;let p=s;let r=0;const e=document.body.appendChild(document.createElement("div"));e.style.position="absolute";e.style.top=A.offsetTop;e.style.left=A.offsetLeft+3;function x(){const t=s+T.maxHealth*2;let n="";for(let e=0;e<Math.floor(p/2);e++){n+="❤️"}if(p%2){n+="❤️‍🩹"}for(let e=Math.ceil(p/2);e<t/2;e++){n+="🩶"}e.innerText=n}let k=0;const t=document.body.appendChild(document.createElement("div"));t.style.position="absolute";t.style.top=A.offsetTop+25;t.style.left=A.offsetLeft+5;t.style.color="#990";t.style;function E(){const e=Math.floor((Date.now()-c)/1e3);t.innerText=!k?"":`Level ${l}\n⭐ ${k}\n${Math.floor(e/60)}:${(100+e%60).toString().substring(1)}`}setInterval(E,1e3);const o=document.body.appendChild(document.createElement("div"));o.style.position="absolute";o.style.top=A.offsetTop+50;o.style.left=A.offsetLeft+10;o.style.color="snow";o.textContent="Press ESC to continue";o.style.display="none";function X(){u.stop();o.style.display=""}function a(e){const t=[];const n=new XMLHttpRequest;n.open("GET",e,false);n.overrideMimeType("text/plain; charset=x-user-defined");n.send(null);if(n.status===200){for(let e=0;e<n.responseText.length;++e){t.push(n.responseText.charCodeAt(e)&255)}}return t}let Y=true;window.addEventListener("blur",function(e){Y=false},false);window.addEventListener("focus",function(e){Y=true},false);let O;function j(){const e=a("rider.13k");O=M1(e);console.log(O);p1(0)}const K=1600;const N=1e3;let U=5;function _(n,o,r,i,a,s,l,e,c,d,t){const h=i/K;const f=a/N;n.fillStyle=e??"black";O.shapes.forEach(e=>{if(e.hidden||e.anim!==l){return}const t=e.lines[s%e.lines.length];if(t){n.beginPath();G(n,o,r,t[0]*h,t[1]*f,false,i,a,c,d);for(let e=2;e<t.length;e+=2){G(n,o,r,t[e]*h,t[e+1]*f,true,i,a,c,d)}n.closePath()}n.fill()})}function G(e,t,n,o,r,i,a,s,l,c){if(i){e.lineTo(t+o,n+r+(o/a-.5)*10*l+c*(Math.random()-.5))}else{e.moveTo(t+o,n+r+(o/a-.5)*10*l+c*(Math.random()-.5))}}const z=.5;function J(e){W[e].x=W[P-1].x;W[e].y=W[P-1].y;W[e].dx=W[P-1].dx;W[e].dy=W[P-1].dy;W[e].born=W[P-1].born;P--}function Q(e){return T.shield&&e.time-(e.lastBlock??-2e4)>(T.shield===2?1e4:2e4)}let P=0;const W=[];function V(e){const{x:t,y:n,dx:o,dy:r,archerOrientation:i}=e;if(P>=W.length){W.push({})}W[P].dx=i*120+o*2;W[P].dy=-5+r*10;W[P].x=t+W[P].dx;W[P].y=n-80*f;W[P].born=e.time;P++}function Z(t,n){const o=Math.min(6,Math.max(C/8,1));for(let e=0;e<o;e++){t(n)}}function e1(e){const t=.7;const n=F(e.ax,e);const o=F(e.ay,e);const r=Math.sqrt(n*n+o*o);if(n!==0){e.orientation=n}const i=F(e.speed,e)*(e.dead?2:1)*(e.superSoldier&&e.soldier?.7:1);const a=F(e.brake,e)-T.control*.01;if(r){e.dx=(e.dx+n/r*i*(1+T.control*1))*a;e.dy=(e.dy+o/r*i/2*(1+T.control*1))*a}else{e.dx=e.dx*a;e.dy=e.dy*a}if(F(e.moving,e)){e.x+=e.dx*t;e.y+=e.dy*t}const s=Math.sqrt(e.dx*e.dx+e.dy*e.dy);e.horseFrame+=t*Math.max(.08,s/50)}let t1=null;function n1(e){I.x=e.x;I.y=e.y+200;I.dx=0;I.dy=0;let t=B(R);t.closed=true;t.onFire=true;R=null;$=false;t1?.();t1=null;x();E()}const q={parent:true,active:()=>true,time:0,nextShot:0,process:e=>{if(!e.parent){return}if(R){if(n.Escape){n1(R);o.style.display="none";u.play()}else{return}}if(!p){if(n.Escape){p=s+T.maxHealth*2;k=0;I.dead=0;o.style.display="none";E();x();u.play()}}if(!p&&e.hero){return}Z(e1,e);if($){e.x=Math.max(-A.width/2,Math.min(e.x,A.width/2));e.y=Math.max(-A.height/2,Math.min(e.y,A.height/2))}const t=F(e.shooting,e);if(!t){e.archerOrientation=e.orientation}else if(T.bow){if(e.time>e.nextShot){V(e);e.nextShot=e.time+F(e.shootPeriod,e)}}},shootPeriod:300,archerOrientation:1,orientation:1,brake:.995,speed:e=>(1+r*.2)*(.08+T.speed*.03)*(F(e.shooting,e)&&!T.speedWhileShooting?.5:1),x:300,y:500,moving:e=>Math.abs(e.dx)>z||Math.abs(e.dy)>z,shooting:()=>n.Space,ax:()=>(n.KeyA||n.ArrowLeft?-1:0)+(n.KeyD||n.ArrowRight?1:0),ay:()=>(n.KeyW||n.ArrowUp?-1:0)+(n.KeyS||n.ArrowDown?1:0),dx:0,dy:0,width:250*f,height:200*f,born:0,horseFrame:0,random:0,riderAnimation:"archer",layer:0,sprites:[e=>F({...e,y:e=>F(e.y,e)-.1,parent:false,sprites:undefined,animation:e=>F(e.riderAnimation,e),range:e=>F(e.rangeOverride,e)??(F(e.shooting,e)?[0,3]:[0]),hotspot:[e=>F(e.moving,e)?.5-e.orientation*F(e.archerOrientation,e)*.05:.53,e=>F(e.moving,e)?.65+Math.sin(e.horseFrame*.7)/100:.7],color:e=>F(e.foeColor,e)??(e.corpse?e.color:e.hut?"#af8":e.tree?"#270":"black"),direction:e=>Math.sign(F(e.archerOrientation,e)),frame:e=>F(e.horseFrame,e),random:4,hidden:e=>e.dead},e),e=>F({...e,process:undefined,y:e=>F(e.y,e),parent:false,sprites:undefined,animation:e=>e.hut?"hut":"horse",range:e=>e.hut?[0]:F(e.moving,e)?[0,10]:[11],hotspot:[.47,.72],color:e=>e.hut&&B(e).closed?"#ba6":e.superSoldier?"#a08":e.foe?"#004":"#630",direction:e=>Math.sign(e.orientation),frame:e=>F(e.horseFrame,e),random:e=>e.superSoldier?100:4,hidden:e=>e.tree&&!e.hut||e.corpse||e.soldier},e),e=>F({...e,process:undefined,y:e=>F(e.y,e)+1,parent:false,sprites:undefined,animation:"shield",range:[0],hotspot:[.47,.72],color:e=>Q(e)&&T.shield>1?"gold":"#69f",direction:e=>Math.sign(e.orientation),frame:()=>0,hidden:e=>!Q(e)||e.foe||e.corpse||e.soldier},e),e=>F({...e,process:undefined,layer:-2,parent:false,sprites:undefined,animation:e=>e.soldier?"soldier":e.corpse?"dead":e.hut?"hut":e.tree?"tree":"horse",range:e=>e.corpse?F(e.rangeOverride,e):e.tree?[0]:F(e.moving,e)?[0,10]:[11],hotspot:e=>e.tree?[.53,1]:[.47,.72],color:"#999",direction:e=>Math.sign(e.orientation),height:-50,frame:e=>F(e.horseFrame,e),hidden:e=>e.dead&&e.soldier},e),...new Array(5).fill(e=>F({...e,process:undefined,cache:false,parent:false,sprites:undefined,animation:"shield",random:150,range:[0],hotspot:[.47+Math.random()-.5,5],width:200,height:30,color:()=>Math.random()<.5?"gold":"red",direction:e=>Math.sign(e.orientation),frame:()=>0,active:e=>e.hut&&B(e).onFire},e))]};function F(t,n){if(typeof t==="object"){if(Array.isArray(t)){return t.map(e=>F(e,n))}else{const o={};for(let e in t){o[e]=F(t[e],n)}return o}}return typeof t==="function"?t(n):t}function o1(e,$,t,L){e.time=$;const n=F(e.sprites,e);n.forEach(e=>{const{x:t,y:n,width:o,height:r,hotspot:i,foeIndex:a,dead:s,color:l,foeColor:c,superSoldier:d,hidden:h,tree:f,active:u}=e;if(!u||h||R&&!f){return}const y=t-i[0]*o-S[0];const m=n-i[1]*r-S[1];const p=y+o;const x=m+r;if(p<0||x<0||y>A.width||m>A.height){return}if(a!==undefined&&!s){for(let e=P-1;e>=0;e--){const g=W[e];if(g.x-S[0]>y&&g.x-S[0]<p&&g.y-S[1]>m&&g.y-S[1]<x){const M=d?Math.random()<.05+.2*T.giantPiercing:true;const v=c1[a];if(M){v.dead=$;s1(v,$,g.dx,c??l);const w=I.x-v.x;const b=I.y-v.y;const C=Math.sqrt(w*w+b*b);v.dx=0;v.dy=0;v.goal[0]=v.x+-w/C*2e3;v.goal[1]=v.y+-b/C*2e3;k+=(d?100:10)*(1+.5*T.money);E()}else{v.hitTime=$}if(Math.random()<T.rickoShot*.3){g.dx*=Math.random()-.5;g.dy=-Math.abs(g.dy)*.8}else{J(e)}if(T.quickShot){I.nextShot=$+50}}}}L.push(e)})}const r1={};function i1(e){let{x:t,y:n,width:o,height:r,animation:i,horseFrame:a,range:s,hotspot:l,color:c,time:d,hitTime:h,dead:f,direction:u,dy:y,random:m,hidden:p,cache:x,hero:g,hut:M}=e;if(M&&!B(e).closed){H=e}if(h&&d-h<50){c=g?"red":"white"}let v=s[0]+(s.length<=1?0:Math.floor(a)%(s[1]-s[0]+1));const w=F(u,q);const b=F(y,q);if(x){const C=O.animations.indexOf(i);const $=`${i}-${v}-${c}-${w}-${o}-${r}`;let e;if(!r1[$]){e=document.createElement("canvas");r1[$]={canvas:e};e.width=o;e.height=r;e.getContext("2d").lineWidth=6;e.getContext("2d").strokeStyle="black";_(e.getContext("2d"),w<0?o:0,r<0?-r:0,o*w,r,v,C,c,0,0)}e=r1[$].canvas;L.drawImage(e,t-l[0]*o-S[0],n-(r<0?0:l[1]*r)-S[1]+D);return}const C=O.animations.indexOf(i);_(L,t-l[0]*o*w-S[0],n-l[1]*r-S[1]+D,o*w,r,v,C,c,b,m)}let g=0;let a1=0;function M(t){if(typeof t==="object"){if(Array.isArray(t)){const o=[...t];for(let e=0;e<o.length;e++){o[e]=M(t[e])}return o}const n={...t};for(let e in n){n[e]=M(t[e])}return n}return t}const I={...M(q),hero:true};let D=0;let v=0;const i=[];function s1(e,t,r,n){const o={...M(q),corpse:true,horseFrame:0,x:e.x,y:e.y,rangeOverride:[0,4],range:undefined,archerOrientation:r<0?1:-1,cache:true,riderAnimation:"dead",born:t,color:n,process:e=>{const t=e.time-e.born;const n=Math.floor(t/50);const o=F(e.rangeOverride[1],e);e.horseFrame=Math.min(n,o);if(e.horseFrame<o){e.x+=r*C/1e3}},width:e.width,height:e.height};if(i.length>200){i.shift()}i.push(o);return o}let w=0;const l1=400;const c1=new Array(l1).fill(0).map((e,t)=>{const n=Math.random()*Math.PI*2;const o=Math.cos(n);const r=Math.sin(n);const d=t%20===0;const i=t%3<=1;const a=o*(2e3+Math.random()*1e3);const s=r*(2e3+Math.random()*1e3);const l=i?Math.max(.01,Math.random()/20):Math.max(.03,Math.random()/10);const c={...M(q),active:()=>t<=w,superSoldier:d,foeIndex:t,foeColor:d?i?"blue":"#a00":i?"#75f":"#f0a",horseFrame:Math.floor(Math.random()*100),goal:[a,s],gdist:0,ax:e=>(e.goal[0]-c.x)/2e3,ay:e=>(e.goal[1]-c.y)/2e3,x:a,y:s,rangeOverride:e=>!F(e.moving,e)?[0]:i?[0,4]:[0,3],speed:()=>l*m,archerOrientation:e=>Math.sign(F(e.dx,e)),cache:true,soldier:i,process:o=>{if(!o.parent||!F(o.active,o)){return}if(o.dead&&o.time-o.dead>5e3){o.dead=0;o.speed=o.soldier?Math.max(.025,Math.random()/30):Math.max(.03,Math.random()/20)}Z(e1,o);const e=o.x-o.goal[0];const t=o.y-o.goal[1];o.gdist=Math.sqrt(e*e+t*t);const n=o.x-I.x;const r=o.y-I.y;const i=Math.sqrt(n*n+r*r);if(i<50&&!o.dead&&p){if(Q(I)){I.lastBlock=I.time}else{h.backgroundColor="#a00";p=Math.max(0,p-(d?2:1));x()}v=40;setTimeout(()=>{h.backgroundColor="#efd"},150);if(!p){s1(I,I.time,(I.x-o.x)*2,I.color);I.dead=I.time;X();u.stop()}const e=Math.random()*Math.PI*2;const t=Math.cos(e);const n=Math.sin(e);o.x=I.x+t*2e3;o.y=I.y+n*2e3;I.dx=0;I.dy=0;I.hitTime=I.time}if(H||!p){if(!o.pausing){o.pausing=true;const a=o.x-(H??I).x;const s=o.y-(H??I).y;const l=Math.sqrt(a*a+s*s);o.goal[0]=I.x+a/l*2e3;o.goal[1]=I.y+s/l*2e3}}else{if(o.pausing){o.pausing=false}if(i>2500){if(Math.random()<.6||!I.dx&&!I.dy){const e=Math.random()*Math.PI*2;const t=Math.cos(e);const n=Math.sin(e);o.x=I.x+t*1500;o.y=I.y+n*1500}else{const c=Math.sqrt(I.dx*I.dx+I.dy*I.dy);o.x=I.x+I.dx*(1e3+Math.random()*500)/c+(Math.random()-.5)*300;o.y=I.y+I.dy*(1e3+Math.random()*500)/c+(Math.random()-.5)*300}if(o.dead){o.dead=0;o.speed=o.soldier?Math.max(.025,Math.random()/30):Math.max(.03,Math.random()/20)}o.gdist=0}if(o.gdist<100||i>(o.soldier?500:3e3)){o.goal[0]=I.x+(I.x-o.x)+(Math.random()-.5)*(o.soldier?200:300);o.goal[1]=I.y+(I.y-o.y)+(Math.random()-.5)*(o.soldier?200:300)}}},foe:true,width:(i?200*f:220*f)*(d?i?2:1.5:1),height:(i?180*f:180*f)*(d?i?2:1.5:1),riderAnimation:i?"soldier":"sword"};return c});let H=null;let R=null;const d1={};const h1=200;const f1=new Array(h1).fill(0).map((e,t)=>{const r=t<=1;const i=r?2e4:4e3;const a=i/2+500;const n={...M(q),cache:true,x:r?t*i:1e3+Math.random()*4e3,y:r?t*i/2:Math.random()*4e3,cellX:0,cellY:0,index:t,process:e=>{if(!e.parent||!F(e.active,e)){return}const t=e.x-I.x;const n=e.y-I.y;const o=Math.sqrt(t*t+n*n);if(o<(r?80:50)){if(r&&!B(e).closed){if(!R){R=e;e.enteredHut=e.time;if(!c){c=Date.now()}if(!B(R).level){B(R).level=l++;t1=d[Math.min(l,d.length-1)]?.()}p=s+T.maxHealth*2;x();X()}}else{v=20;I.x-=t;I.y-=n;I.dx*=T.treeNav*.3;I.dy*=T.treeNav*.3}}if(t>a*2){e.x-=i*2;e.cellX--}else if(t<-a*2){e.x+=i*2;e.cellX++}if(n>a){e.y-=i;e.cellY--}else if(n<-a){e.y+=i;e.cellY++}},foe:true,width:(r?600:500)*f,height:(r?400:350+Math.random()*200)*f,riderAnimation:r?"hut":"tree",foeColor:r?`rgb(${200}, ${100+t*55}, ${50+t*50})`:`rgb(${Math.random()*30}, ${Math.random()*150}, ${Math.random()*20})`,tree:true,hut:r,rangeOverride:r?[1]:undefined};return n});let l=0;function B(e){const t=`${e.cellX}_${e.cellY}_${e.index}`;return d1[t]??(d1[t]={})}function u1(e,t){const n=e.x-t.x;const o=e.y-t.y;return n*n+o*o}function y1(){const t=f1.filter(e=>e.hut&&!B(e).closed);let n=t[0];for(let e=1;e<t.length;e++){if(u1(t[e],I)<u1(n,I)){n=t[e]}}return n}const m1=[[I],c1,i,f1];let b=null;let C;function p1(t){requestAnimationFrame(p1);if(!Y){return}g=Math.max(g,t-100);C=t-g;g=t;if(v){D=Math.random()*v;v*=.5;if(v<.1){v=0}}L.clearRect(0,0,A.width,A.height);Z(x1,W);L.beginPath();L.strokeStyle="#038";L.lineWidth=6;const e=.7;for(let e=0;e<P;e++){const o=W[e];const r=50;const i=Math.sqrt(o.dx*o.dx+o.dy*o.dy)+1;L.moveTo(o.x-S[0],o.y-S[1]+D);L.lineTo(o.x-S[0]-o.dx/i*r,o.y-S[1]+D-o.dy/i*r)}L.stroke();for(let e=P-1;e>=0;e--){if(t-W[e].born>1500){J(e)}}L.strokeStyle="#380";L.lineWidth=2;y.length=0;g1(y);m1.forEach(e=>e.forEach(e=>o1(e,t,C,y)));y.sort((e,t)=>{if(e.layer!==t.layer){return e.layer-t.layer}return Math.sign(e.y-t.y)});H=null;y.forEach(e=>i1(e,t));const n=y1();if(n){const a=n.x-I.x;const s=n.y-I.y;const l=Math.sqrt(a*a+s*s);if(l>2e3){if(!b){b=[I.x,I.y]}L.beginPath();const c=2e3;const d=I.x+a/l*c-S[0];const h=I.y+s/l*c-S[1];b[0]+=(d-b[0])*.1;b[1]+=(h-b[1])*.1;L.arc(Math.min(A.width-80,Math.max(80,b[0])),Math.min(A.height-80,Math.max(80,b[1])),15,0,2*Math.PI);L.fill()}}if(!p){const f=Math.min(.7,(t-I.dead)/3e3);L.fillStyle=`rgb(200,0,0,${f})`;L.fillRect(0,0,A.width,A.height);L.fill()}else if(!R){if(!$){a1+=((I.dx*I.archerOrientation<0?0:I.dx)/2+I.archerOrientation-a1)*.05;const C=20;S[0]+=C/20*(I.x-A.width/2-S[0]+a1*80)*.1;S[1]+=C/20*(I.y-A.height/2-S[1]+I.dy*50)*.1}else{S[0]=-A.width/2;S[1]=-A.height/2}}else{const u=Math.min(1,(t-R.enteredHut)/500);L.fillStyle=`rgb(0,0,0,${u})`;L.fillRect(0,0,A.width,A.height);L.fill()}}function x1(t){const n=.4;const o=50;for(let e=0;e<P;e++){const r=t[e];const i=Math.sqrt(r.dx*r.dx+r.dy*r.dy)+1;r.dy+=.3;r.x+=r.dx/i*o*n;r.y+=r.dy/i*o*n}}function g1(){const n=200;L.beginPath();const o=[Math.round(S[0]/n),Math.round(S[1]/n)];for(let t=-15;t<15;t++){for(let e=-20;e<20;e++){const r=e+o[0];const i=t+o[1];const a=Math.sin(r*123+i*9991)+Math.sin(r*123/10+i*9991/100)+Math.sin(r*123/10+i*9991/100);const s=Math.cos(r*12331+i*2221)+Math.cos(r*12331/10+i*2221/10)+Math.cos(r*12331/100+i*2221/100);const l=a*500;const c=s*200;const d=r*n-S[0]+l;const h=i*n-S[1]+c;L.moveTo(d,h+D);L.lineTo(d+a*100,h+D+3);L.lineTo(d+a*100+s*100,h+D)}}L.stroke()}j()},3e3)});