function i(t){const n=new Array(Math.ceil(t.length*2));for(let e=0;e<t.length;e++){n[e*2]=t[e]%16;n[e*2+1]=(t[e]>>4)%16}return n}function r(e){const t=[0,0];let n=0,o=0;do{n=e.pop()-7;o=e.pop()-7;t[0]+=n;t[1]+=o}while(n||o);let i,r;do{n=e.pop()-7;o=e.pop()-7;if(n||o){const a=i*o;const s=r*n;if(Math.abs(a-s)<5){t[t.length-2]+=n;t[t.length-1]+=o}else{t.push(t[t.length-2]+n,t[t.length-1]+o)}i=n;r=o}}while(n||o);return t}function a(t,n){const o=new Array(t.pop());for(let e=0;e<o.length;e++){o[e]=r(t).map(e=>e*n)}return o}function s(t){const n=t.pop();const o=[];for(let e=0;e<n;e++){const i=t.pop()+(t.pop()<<4);o.push(String.fromCharCode(i))}return o.join("")}function l(t,n){const o=new Array(t.pop());for(let e=0;e<o.length;e++){o[e]={};o[e].name=s(t);o[e].lines=a(t,n);o[e].anim=t.pop();const i=t.pop();o[e].hidden=i===1}return o}function c(t){const n=new Array(t.pop());for(let e=0;e<n.length;e++){n[e]=s(t)}return n}function Ye(e){const t=i(e);const n={};t.reverse();const o=t.pop();n.animations=c(t);n.shapes=l(t,o);return n}"use strict";var t=function(){var K=function(e){return Math.sin(e*6.283184)};var e=function(e){return 2*(e%1)-1};var t=function(e){return e%1<.5?1:-1};var n=function(e){var t=e%1*4;if(t<2)return t-1;return 3-t};var C=function(e){return.003959503758*2**((e-128)/12)};var Y=function(e,t,n){var o=G[e.i[0]],i=e.i[1],r=e.i[3]/32,a=G[e.i[4]],s=e.i[5],l=e.i[8]/32,c=e.i[9],d=e.i[10]*e.i[10]*4,h=e.i[11]*e.i[11]*4,f=e.i[12]*e.i[12]*4,u=1/f,m=-e.i[13]/16,p=e.i[14],y=n*2**(2-e.i[15]);var g=new Int32Array(d+h+f);var x=0,M=0;var b,w,v,k,S,$,A;for(b=0,w=0;b<d+h+f;b++,w++){if(w>=0){p=p>>8|(p&255)<<4;w-=y;$=C(t+(p&15)+e.i[2]-128);A=C(t+(p&15)+e.i[6]-128)*(1+8e-4*e.i[7])}v=1;if(b<d){v=b/d}else if(b>=d+h){v=(b-d-h)*u;v=(1-v)*3**(m*v)}x+=$*v**r;S=o(x)*i;M+=A*v**l;S+=a(M)*s;if(c){S+=(2*Math.random()-1)*c}g[b]=80*S*v|0}return g};var G=[K,t,e,n];var N,U,X,J,_;this.init=function(e){N=e;U=e.endPattern;X=0;J=e.rowLen*e.patternLen*(U+1)*2;_=new Int32Array(J)};this.generate=function(){var e,t,H,n,o,i,r,a,s,l,R,B,j,c,d,h,D;var f=new Int32Array(J),u=N.songData[X],m=N.rowLen,p=N.patternLen;var y=0,g=0,x;var M,b=false;var w=[];for(n=0;n<=U;++n){a=u.p[n];for(o=0;o<p;++o){var v=a?u.c[a-1].f[o]:0;if(v){u.i[v-1]=u.c[a-1].f[o+p]||0;if(v<17){w=[]}}var k=G[u.i[16]],S=u.i[17]/512,$=2**(u.i[18]-9)/m,A=u.i[19],C=u.i[20],T=u.i[21]*43.23529*3.141592/44100,E=1-u.i[22]/255,L=u.i[23]*1e-5,O=u.i[24]/32,q=u.i[25]/512,W=6.283184*2**(u.i[26]-9)/m,P=u.i[27]/255,I=u.i[28]*m&~1;d=(n*p+o)*m;for(i=0;i<4;++i){r=a?u.c[a-1].n[o+i*p]:0;if(r){if(!w[r]){w[r]=Y(u,r,m)}var F=w[r];for(t=0,e=d*2;t<F.length;t++,e+=2){f[e]+=F[t]}}}for(t=0;t<m;t++){s=(d+t)*2;c=f[s];if(c||b){h=T;if(A){h*=k($*s)*S+.5}h=1.5*Math.sin(h);y+=h*g;x=E*(c-g)-y;g+=h*x;c=C==3?g:C==1?x:y;if(L){c*=L;c=c<1?c>-1?K(c*.25):-1:1;c/=L}c*=O;b=c*c>1e-5;l=Math.sin(W*s)*q+.5;M=c*(1-l);c*=l}else{M=0}if(s>=I){M+=f[s-I+1]*P;c+=f[s-I]*P}f[s]=M|0;f[s+1]=c|0;_[s]+=M|0;_[s+1]+=c|0}}}X++;return X/N.numChannels};this.createWave=function(){var e=44;var t=e+J*2-8;var n=t-36;var o=new Uint8Array(e+J*2);o.set([82,73,70,70,t&255,t>>8&255,t>>16&255,t>>24&255,87,65,86,69,102,109,116,32,16,0,0,0,1,0,2,0,68,172,0,0,16,177,2,0,4,0,16,0,100,97,116,97,n&255,n>>8&255,n>>16&255,n>>24&255]);for(var i=0,r=e;i<J;++i){var a=_[i];a=a<-32767?-32767:a>32767?32767:a;o[r++]=a&255;o[r++]=a>>8&255}return o}};var Ge={songData:[{i:[3,194,128,0,2,198,128,6,0,0,12,12,33,0,0,0,0,61,4,1,2,109,86,7,32,112,3,67,2],p:[1,1,2,3,4,5,1,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132,132,,135,132,,135,134,132],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]},{n:[132,,135,132,,135,134,132,132,,135,132,,135,134,132,127,,130,127,,130,129,127,127,,130,127,,130,129,127],f:[]},{n:[125,,128,125,,128,127,125,125,,128,125,,128,127,125,122,,125,122,,125,123,122,123,,127,123,,127,125,123],f:[]},{n:[125,,123,122,,125,123,122,125,,123,122,,125,123,122,118,,115,118,,122,120,122,118,,115,118,,122,120,118],f:[]},{n:[],f:[]},{n:[135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,139,135,,139,137,135,135,,137,135,,135,134,132],f:[]},{n:[128,,132,128,,132,130,128,128,,132,128,,132,130,128,128,,132,128,,132,130,128,130,,134,130,,134,132,130],f:[]},{n:[130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130,130,,134,130,,134,132,130],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,4,5,,2,3,4,5,,,6,7,8,9],c:[{n:[],f:[]},{n:[139,,,144,,,146,,147,,,146,,,144,,142,,,144,,,146,,139],f:[]},{n:[139,,,144,,,146,,147,,,146,,,147,,149,,,147,,,149,,151,,,,,,151],f:[]},{n:[152,,,154,,,151,,149,,,151,,,147,,146,,,142,,,146,,147],f:[]},{n:[149,,,146,,,149,,147,,,144,,,147,,146,,,142,,,144,,144],f:[]},{n:[,,,,139,,,,144,,139,,147,,,,144,,,,147,,144,,151,,,,147],f:[]},{n:[151,,147,,154,,,,142,,,,147,,142,,151,,,,,,142,,144,,140,,147],f:[]},{n:[,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,142,,144,,140,,147,,,,,,142,,144,,140,,149,,,,142,,,,147,,142],f:[]},{n:[151],f:[]}]},{i:[2,29,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,2,3,4,5,,2,3,4,5,5,1,1,7,8,9],c:[{n:[132,,,,,,,,,,,,,,,,132],f:[]},{n:[132,,,,,,,,,,,,,,,,130],f:[]},{n:[132,,,,,,,,,,,,,,,,135],f:[]},{n:[140,,,,,,,,,,,,,,,,137],f:[]},{n:[134,,,,,,,,,,,,,,,,132],f:[]},{n:[],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[135,,,,,,,,,,,,,,,,135],f:[]},{n:[134,,,,,,,,,,,,,,,,130],f:[]}]},{i:[0,255,117,64,0,255,110,0,64,0,4,6,35,0,0,0,0,0,0,0,2,14,0,1,39,76,5,0,0],p:[,1,1,1,1,1,1,1,1,1,1,,1,1,1,1,1],c:[{n:[135,,,,144,,,,135,,,,144,,,,135,,,,144,,,,135,,,,144,,144],f:[]}]},{i:[0,89,152,0,0,255,152,12,0,0,2,0,60,0,0,0,0,0,0,0,2,255,0,0,32,47,3,157,2],p:[,,,,,,,2,3,4,,5],c:[{n:[],f:[]},{n:[,,,,,,,,135,,,,,,,,134,,,,,,,,132,,,,130],f:[]},{n:[127,,,,,,,,,,,,135,,,,134,,,,132,,,,130],f:[]},{n:[132],f:[]},{n:[137,,,134,,,137,,135,,,132,,,135,,134,,,130,,,132,,132],f:[]}]}],rowLen:5513,patternLen:32,endPattern:16,numChannels:5};var Ne={songData:[{i:[2,24,128,0,3,27,128,0,0,0,0,6,29,0,0,0,0,195,4,1,3,50,184,119,244,147,6,84,6],p:[1,1,4,5,6,3,4,5,6,2,1,1,1,3,1,3],c:[{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,135,140,,139,137,135,140,,135,140,,139,137,135,132,,135,134,,135,134,132,132,,135,134,,135,134,132],f:[]},{n:[140,,139,140,,139,137,135,140,,139,140,,139,137,135,134,,130,134,,132,127,127,134,,127,134,,132,130,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,127,,130,129,,130,129,127,127,,130,130,,130,129,127],f:[]},{n:[132,,135,134,,135,134,132,132,,135,134,,135,134,132,137,,135,137,,140,139,137,137,,135,137,,140,139,137],f:[]},{n:[135,,139,137,,139,137,135,135,,139,137,,139,137,135,140,,135,140,,139,137,135,140,,135,140,,139,137,135],f:[]}]},{i:[2,100,128,0,3,201,128,0,0,0,5,6,58,0,0,0,0,195,6,1,2,135,0,0,32,147,6,121,6],p:[,,2,3,6,7,2,3,6,1,,4,5,8,9,10],c:[{n:[140,,139,,137,,135,,134,,,,,,132,,132],f:[]},{n:[132,134,135,134,132,,,,,,,,134,,,,130,,,,127],f:[]},{n:[132,134,135,134,132,,,,,,134,,,,135,,137],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[139,,,,,,,,137,,,,,,,,135,,,,,,,,137],f:[]},{n:[135,137,139,137,135,,,,,,137,,,,139,,140,,,,135,,,,,,,,135],f:[]},{n:[140,,139,,137,,135,,137,,,,,,132,,134],f:[]},{n:[,,,,,,,,,,,,,,,,132,,,,,,,,135],f:[]},{n:[142,,,,,,,,140,,,,,,,,135,,,,,,,,137],f:[]},{n:[139],f:[]}]},{i:[1,192,128,0,1,191,116,9,0,0,6,22,34,0,0,0,0,69,3,1,1,23,167,0,32,77,6,25,6],p:[,,1,2,3,4,1,2,3,5,1,1,2,3,1,4],c:[{n:[120,,,,120,,,,120,,,,120,,,,115,,,,115,,,,115,,,,115],f:[]},{n:[120,,,,120,,,,120,,,,120,,,,125,,,,125,,,,125,,,,125],f:[]},{n:[123,,,,123,,,,123,,,,123,,,,128,,,,128,,,,123,,,,123],f:[]},{n:[128,,,,123,,,,125,,,,123,,,,122,,,,115,,,,122,,,,115],f:[]},{n:[128,,,,123,,,,122,,,,115,,,,120,,,,120,,,,120,,,,120],f:[]}]},{i:[0,160,128,64,0,160,128,0,64,210,4,7,52,85,0,0,0,60,4,1,2,255,0,0,32,61,5,32,6],p:[,1,2,2,2,1,2,2,2,1,2,2,2,2,2,1],c:[{n:[118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,,,,118,118,118,,,,,,,,119,,,,,,,,119,,,,,,,,119,,,,119],f:[]},{n:[111,,,,132,,,,111,,,,132,,,,111,,,,132,,,,111,,,,132,,132],f:[]}]},{i:[2,138,116,0,2,138,128,4,0,0,47,48,162,63,124,3,0,139,4,1,3,64,160,3,32,147,4,121,5],p:[,,,,,,1,2,3,4,5,6],c:[{n:[120,,,,,,,,120,,,,,,,,115,,,,,,,,115],f:[]},{n:[120,,,,,,,,120,,,,,,,,125,,,,,,,,125],f:[]},{n:[123,,,,,,,,123,,,,,,,,128,,,,,,,,123],f:[]},{n:[125,,,,,,,,,,,,,,,,132,,,,,,,,132,,,,,,134],f:[]},{n:[119,,,,,,,,,,,,,,,,120,,,,,,,,120,,,,,,122],f:[]},{n:[119,,,,,,,,,,,,,,,,120],f:[]}]}],rowLen:4725,patternLen:32,endPattern:15,numChannels:5};class Ue{constructor(e){this.player=new t;this.player.init(e);this.prepare();this.playing=false}prepare(){const n=setInterval(()=>{const e=this.player.generate();if(e>=1){clearInterval(n);var t=this.player.createWave();this.audio=document.createElement("audio");this.audio.src=URL.createObjectURL(new Blob([t],{type:"audio/wav"}));this.audio.loop=true}},0)}play(){this.audio?.play();this.playing=true}pause(){this.audio?.pause()}resume(){if(this.playing){this.play()}}stop(){if(this.audio){this.pause();this.audio.currentTime=0}}}let Xe=document.querySelector.bind(document);document.addEventListener("DOMContentLoaded",()=>{Xe("body").style.backgroundColor="#100";Xe("h3").style.opacity=1;setTimeout(()=>{let A=Xe("canvas");let $=A.getContext("2d");let h=A.style;A.width=2e3;h.width=`${A.width/2}px`;A.height=1200;h.height=`${A.height/2}px`;h.border="1px solid black";h.backgroundColor="#efd";setTimeout(()=>h.opacity=1,1e3);const d=200;const f=.75;const r={};document.addEventListener("keyup",e=>{delete r[e.code]});function S(){me(R);n();i("");s.play();return true}document.addEventListener("mousemove",()=>{h.cursor=""});document.addEventListener("keydown",t=>{r[t.code]=true;h.cursor="none";if(l.style.display===""){const n=Te;let e=false;const o=!T.bow;if(r.KeyW||r.ArrowUp)c=Math.max(0,c-1);if(r.KeyS||r.ArrowDown)c=Math.min(n.length-(o?1:0),c+1);if(r.Space){if(c===n.length){e=S()}else if(!Ce[c]){const i=[...a].filter($e)[c];if(i){Ce[c]=true;E-=i.cost[0]*d;L();i?.buy(i);if(o){e=S()}}}}delete r[t.code];if(!e){Ee(true)}}t.preventDefault()});function n(){l.style.display="none"}const m=[];const C=[0,0];let p=true;let s=new Ue(Ge);const j=new Ue(Ne);let o=0;function e(e){T[e.name]++;if(!e.recurring){e.cost.shift()}}function D(e,t){return new Array(t).fill(e).join("")}let W;const a=[W={name:"bow",title:"Bow and arrows",description:"(Recommended) To shoot down enemies and collect 🏵️",cost:[0],buy:e},{name:"speed",title:"Speed boost",description:()=>`Change hoof for faster horse (${D("⭐",T.speed+1)})`,cost:[0,2,3],buy:e},{name:"speedWhileShooting",title:"Stable aim",description:"Stabilize bow to shoot without slow down the horse",cost:[2],req:"bow",buy:e},{name:"maxHealth",title:"Max health",description:"Eat foot to increases the maximum health by one ❤️",cost:[2,3,4],buy:e},{name:"shield",title:"Shield",description:()=>`This shield blocks one hit. Re-usable after ${20/(T.shield+1)}s`,cost:[2,4],buy:e},{name:"quickShot",title:"Quick shot",description:"Learn a skill to shoot immediately after one hit",cost:[2],req:"bow",buy:e},{name:"money",title:"Pillage",description:()=>`Earn knowledge of finding loot. Each kill provides more 🏵️ (x${2+T.money})`,cost:[1,2,3],req:"bow",buy:e},{name:"rickoShot",title:"Rickoshot",description:()=>`Learn a skill. Arrow aimed properly has +${30*(T.rickoShot+1)}% chance to rickochet after hitting.`,cost:[1,2,3],req:"bow",buy:e},{name:"giantPiercing",title:"Giant piercing",description:()=>`Sharpened arrows increases chance of killing a giant from ${5+20*T.giantPiercing}% to ${5+20*(T.giantPiercing+1)}%`,cost:[1,2,3],req:"bow",buy:e},{name:"treeNav",title:"Forest navigation",description:()=>`A compass to help navigation in forest (${D("⭐",T.treeNav+1)})`,cost:[1,2,3],buy:e},{name:"control",title:"Horse control",description:()=>`Improved saddle for better control (${D("⭐",T.control+1)})`,cost:[1,2,3],buy:e},{name:"time",title:"Extra time",description:"In exchange of 🏵️, I will delay the boat (+15s)",recurring:1,cost:[.5],buy:()=>{o+=15e3;L();i("This will give you a bit more time.")}},{name:"health",title:"Rejuvinate",description:"Drink kumis, restore health to max",recurring:1,cost:[1],buy:()=>{y=Y+T.maxHealth*2;L();i("This ale should give you energy to go on!")}},{name:"gamble",title:"Gamble",description:e=>`Play a game of Shagai.(30% chance to double your 🏵️)`,reccurring:1,cost:[.5],buy:()=>{if(Math.random()<=.35){E+=d;E*=2;L();i("Lucky!")}else{i("You lost, my friend")}}}];let T={...Object.fromEntries(a.map(e=>[e.name,0])),borte:0};window.shop=a;window.upgrades=T;function i(e){z.style.display=e.length?"":"none";z.innerText=e}const t="Börte is in another hut, but I'll sell you some items for 🏵️";const K=[()=>{},()=>{w=20;const e=`Spare my life, Great Khan! I'll help you find Börte.\nHurry! Jamukha plans to send her away on a boat.\nTake one item, then follow the sign.`;i(e)},()=>{w=40;u+=.1;i(t)},()=>{w=50;u+=.1;i(t)},()=>{w=60;u+=.1;i(t)},()=>{w=70;i(t)},()=>{w=80;u+=.1;i(t)},()=>{w=100;u+=.1;const e=s;Ie();i(`Börte is found, alive and well.\nBörte: "Took you long enough! Jamukha escaped. Let's go after him, I'll ride with you."`);return()=>e.stop()},()=>{i(`Level ${He}\nBörte found Jamukha and got her revenge. (Congratulations! You beat the game, but feel free keep going)`);w=Math.min(w+50,400);u+=.1}];let u=.7;const Y=6;let y=Y;let G=0;let N=60*8;let U=0;let E=0;const X=document.body.appendChild(document.createElement("div"));const J=X.style;J.position="absolute";J.top=A.offsetTop+25;J.left=A.offsetLeft+20;J.color="#880";let _=()=>U||Math.max(R?R.enteredHut:g||x);function L(){const t=Y+T.maxHealth*2;let n="";for(let e=0;e<Math.floor(y/2);e++){n+="❤️"}if(y%2){n+="❤️‍🩹"}for(let e=Math.ceil(y/2);e<t/2;e++){n+="🩶"}const e=Math.max(0,N-Math.floor((_()-o)/1e3));X.innerText=p?"":`Level ${He}\n${n}\n🏵️ ${E}\n${Math.floor(e/60)}:${(100+e%60).toString().substring(1)}`;if(y&&e<=0){y=0;ve()}}setInterval(L,1e3);const z=document.body.appendChild(document.createElement("div"));const Q=z.style;Q.position="absolute";Q.top=A.offsetTop+50;Q.left=A.offsetLeft+150;i("");function V(){s.stop();i("GAME OVER, KHAN"+(pe()?"\nESC to continue. You will lose all money and one upgrade.":""))}function Z(e){const t=[];const n=new XMLHttpRequest;n.open("GET",e,false);n.overrideMimeType("text/plain; charset=x-user-defined");n.send(null);if(n.status===200){for(let e=0;e<n.responseText.length;++e){t.push(n.responseText.charCodeAt(e)&255)}}return t}let g=0;window.addEventListener("blur",function(e){if(!g){g=x;s.pause()}},false);window.addEventListener("focus",function(e){if(g){o+=x-g;g=0;if(!R&&!F.dead){s.resume()}}},false);let ee;function te(){const e=Z("rider.13k");ee=Ye(e);De(0)}const ne=1600;const oe=1e3;let ie=5;function re(n,o,i,r,a,s,l,e,c,d,t){const h=r/ne;const f=a/oe;n.fillStyle=e??"black";ee.shapes.forEach(e=>{if(e.hidden||e.anim!==l){return}const t=e.lines[s%e.lines.length];if(t){n.beginPath();ae(n,o,i,t[0]*h,t[1]*f,false,r,a,c,d);for(let e=2;e<t.length;e+=2){ae(n,o,i,t[e]*h,t[e+1]*f,true,r,a,c,d)}n.closePath()}n.fill()})}function ae(e,t,n,o,i,r,a,s,l,c){if(r){e.lineTo(t+o,n+i+(o/a-.5)*5*l+c*(Math.random()-.5))}else{e.moveTo(t+o,n+i+(o/a-.5)*5*l+c*(Math.random()-.5))}}const se=.5;function le(e){q[e].x=q[O-1].x;q[e].y=q[O-1].y;q[e].dx=q[O-1].dx;q[e].dy=q[O-1].dy;q[e].born=q[O-1].born;O--}function ce(e){return T.shield&&e.time-(e.lastBlock??-2e4)>(T.shield===2?1e4:2e4)}let O=0;const q=[];function de(e){const{x:t,y:n,dx:o,dy:i,archerOrientation:r}=e;if(O>=q.length){q.push({})}q[O].dx=I(r,e)*120+o*2;q[O].dy=-5+i*10;q[O].x=t+q[O].dx;q[O].y=n-80*f;q[O].born=e.time;O++}function he(t,n){const o=Math.min(6,Math.max(k/8,1));for(let e=0;e<o;e++){t(n)}}function fe(e){const t=.7;const n=I(e.ax,e);const o=I(e.ay,e);const i=Math.sqrt(n*n+o*o);if(n!==0){e.orientation=n}const r=I(e.speed,e)*(e.dead?1.5:1)*(e.superSoldier&&e.soldier?.8:1);const a=I(e.control,e)??0;const s=I(e.brake,e)-a*.01;if(i){e.dx=(e.dx+n/i*r*(1+a))*s;e.dy=(e.dy+o/i*r/2*(1+a))*s}else{e.dx=e.dx*s;e.dy=e.dy*s}if(I(e.moving,e)){e.x+=e.dx*t;e.y+=e.dy*t}const l=Math.sqrt(e.dx*e.dx+e.dy*e.dy);e.horseFrame+=t*Math.max(.08,l/50)}let ue=null;function me(e){if(p){o=x}else{o+=x-R.enteredHut}F.x=e.x;F.y=e.y+200;F.dx=0;F.dy=0;let t=B(R);t.closed=true;t.onFire=true;R=null;p=false;ue?.();ue=null;L()}function pe(){return Object.keys(T).filter(e=>T[e]).length}const P={parent:true,active:()=>true,time:0,nextShot:0,process:e=>{if(!e.parent){return}if(R){}if(!y&&r.Escape&&pe()){y=Y+T.maxHealth*2;E=0;F.dead=0;i("");o=Math.max(o,_()-N*1e3+6e4);s.play();const n=Object.keys(T).filter(e=>T[e]).sort(()=>Math.random()-.5)[0];T[n]--;if(n==="bow"){W.cost.push(0)}L()}if(!y&&e.hero){return}he(fe,e);if(p){e.x=Math.max(-A.width/2,Math.min(e.x,A.width/2));e.y=Math.max(-A.height/2,Math.min(e.y,A.height/2))}const t=I(e.shooting,e);if(!t){e.archerOrientation=e.orientation}else if(T.bow){if(e.time>e.nextShot){de(e);e.nextShot=e.time+I(e.shootPeriod,e)}}},shootPeriod:300,archerOrientation:1,orientation:1,brake:.99,speed:e=>(1+G*.2)*(.08+T.speed*.03)*(I(e.shooting,e)&&!T.speedWhileShooting?.5:1),x:300,y:500,moving:e=>Math.abs(e.dx)>se||Math.abs(e.dy)>se,shooting:()=>r.Space,ax:()=>(r.KeyA||r.ArrowLeft?-1:0)+(r.KeyD||r.ArrowRight?1:0),ay:()=>(r.KeyW||r.ArrowUp?-1:0)+(r.KeyS||r.ArrowDown?1:0),dx:0,dy:0,width:250*f,height:200*f,born:0,horseFrame:0,random:0,riderAnimation:"archer",layer:0,control:()=>T.control,sprites:[e=>I({...e,y:e=>I(e.y,e)-.1,parent:false,sprites:undefined,animation:e=>I(e.riderAnimation,e),range:e=>I(e.rangeOverride,e)??(I(e.shooting,e)?[0,3]:[0]),hotspot:[e=>I(e.moving,e)?.5-e.orientation*I(e.archerOrientation,e)*.05:.53,e=>I(e.moving,e)?.65+Math.sin(e.horseFrame*.7)/100:.7],color:e=>I(e.foeColor,e)??(e.corpse?e.color:e.hut?"#af8":e.tree?"#270":"black"),direction:e=>Math.sign(I(e.archerOrientation,e)),frame:e=>I(e.horseFrame,e),random:4,hidden:e=>e.dead},e),e=>I({...e,process:undefined,parent:false,sprites:undefined,animation:e=>e.hut?"hut":"horse",range:e=>e.hut?[0]:I(e.moving,e)?[0,10]:[11],hotspot:[.47,.72],color:e=>e.borte?"#f98":e.hut&&B(e).closed?"#ba6":e.superSoldier?"#a08":e.foe?"#004":"#630",direction:e=>Math.sign(e.orientation),frame:e=>I(e.horseFrame,e),random:e=>e.superSoldier?100:4,hidden:e=>e.tree&&!e.hut||e.corpse||e.soldier},e),e=>I({...e,process:undefined,y:e=>I(e.y,e)+1,parent:false,sprites:undefined,animation:"shield",range:[0],hotspot:[.47,.72],color:e=>ce(e)&&T.shield>1?"gold":"#69f",direction:e=>Math.sign(e.orientation),frame:()=>0,hidden:e=>!ce(e)||e.foe||e.corpse||e.soldier},e),e=>I({...e,process:undefined,layer:-2,parent:false,sprites:undefined,animation:e=>e.soldier?"soldier":e.corpse?"dead":e.hut?"hut":e.tree?"tree":"horse",range:e=>e.corpse?I(e.rangeOverride,e):e.tree?[0]:I(e.moving,e)?[0,10]:[11],hotspot:e=>e.tree?[.53,1]:[.47,.72],color:"#999",direction:e=>Math.sign(e.orientation),height:-50,frame:e=>I(e.horseFrame,e),hidden:e=>e.dead&&e.soldier},e),...new Array(5).fill(e=>I({...e,process:undefined,cache:false,parent:false,sprites:undefined,animation:"shield",random:150,range:[0],hotspot:[.47+Math.random()-.5,5],width:200,height:30,color:()=>Math.random()<.5?"gold":"red",direction:e=>Math.sign(e.orientation),frame:()=>0,active:e=>e.hut&&B(e).onFire},e))]};function I(t,n){if(typeof t==="object"){if(Array.isArray(t)){return t.map(e=>I(e,n))}else{const o={};for(let e in t){o[e]=I(t[e],n)}return o}}return typeof t==="function"?t(n):t}function ye(e,S,t,$){e.time=S;const n=I(e.sprites,e);n.forEach(e=>{const{x:t,y:n,width:o,height:i,hotspot:r,foeIndex:a,dead:s,color:l,foeColor:c,superSoldier:d,hidden:h,tree:f,active:u}=e;if(!u||h||R&&!f){return}const m=t-r[0]*o-C[0];const p=n-r[1]*i-C[1];const y=m+o;const g=p+i;if(y<0||g<0||m>A.width||p>A.height){return}if(a!==undefined&&!s){for(let e=O-1;e>=0;e--){const x=q[e];if(x.x-C[0]>m&&x.x-C[0]<y&&x.y-C[1]>p&&x.y-C[1]<g){const M=d?Math.random()<.05+.2*T.giantPiercing:true;const b=Se[a];if(M){b.dead=S;we(b,S,x.dx,c??l);const w=F.x-b.x;const v=F.y-b.y;const k=Math.sqrt(w*w+v*v);b.dx=0;b.dy=0;b.goal[0]=b.x+-w/k*2e3;b.goal[1]=b.y+-v/k*2e3;E+=(d?50:8)*(1+T.money);L()}else{b.hitTime=S}if(Math.random()<T.rickoShot*.3){x.dx*=Math.random()-.5;x.dy=-Math.abs(x.dy)*.8}else{le(e)}if(T.quickShot){F.nextShot=S+50}}}}$.push(e)})}const ge={};function xe(e){let{x:t,y:n,width:o,height:i,animation:r,horseFrame:a,range:s,hotspot:l,color:c,time:d,hitTime:h,dead:f,direction:u,dy:m,random:p,hidden:y,cache:g,hero:x,hut:M}=e;if(M&&!B(e).closed){Le=e}if(h&&d-h<50){c=x?"red":"white"}let b=s[0]+(s.length<=1?0:Math.floor(a)%(s[1]-s[0]+1));const w=I(u,P);const v=I(m,P);if(g){const k=ee.animations.indexOf(r);const S=`${r}-${b}-${c}-${w}-${o}-${i}`;let e;if(!ge[S]){e=document.createElement("canvas");ge[S]={canvas:e};e.width=o;e.height=i;e.getContext("2d").lineWidth=6;e.getContext("2d").strokeStyle="black";re(e.getContext("2d"),w<0?o:0,i<0?-i:0,o*w,i,b,k,c,0,0)}e=ge[S].canvas;$.drawImage(e,t-l[0]*o-C[0],n-(i<0?0:l[1]*i)-C[1]+H);return}const k=ee.animations.indexOf(r);re($,t-l[0]*o*w-C[0],n-l[1]*i-C[1]+H,o*w,i,b,k,c,v,p)}let x=0;let Me=0;function M(t){if(typeof t==="object"){if(Array.isArray(t)){const o=[...t];for(let e=0;e<o.length;e++){o[e]=M(t[e])}return o}const n={...t};for(let e in n){n[e]=M(t[e])}return n}return t}const F={...M(P),hero:true};let H=0;let b=0;const be=[];function we(e,t,i,n){const o={...M(P),corpse:true,horseFrame:0,x:e.x,y:e.y,rangeOverride:[0,4],range:undefined,archerOrientation:i<0?1:-1,cache:true,riderAnimation:"dead",born:t,color:n,process:e=>{const t=e.time-e.born;const n=Math.floor(t/50);const o=I(e.rangeOverride[1],e);e.horseFrame=Math.min(n,o);if(e.horseFrame<o){e.x+=i*k/1e3}},width:e.width,height:e.height};if(be.length>200){be.shift()}be.push(o);return o}function ve(){b=40;setTimeout(()=>{h.backgroundColor="#efd"},150);if(!y){we(F,F.time,(F.x-P.x)*2,F.color);F.dead=F.time;V();s.stop()}}let w=0;const ke=400;const Se=new Array(ke).fill(0).map((e,t)=>{const n=Math.random()*Math.PI*2;const o=Math.cos(n);const i=Math.sin(n);const d=t%20===0&&t>30;const r=t%3<=1;const a=o*(2e3+Math.random()*1e3);const s=i*(2e3+Math.random()*1e3);const l=r?Math.max(.01,Math.random()/20):Math.max(.03,Math.random()/10);const c={...M(P),active:()=>t<=w,superSoldier:d,foeIndex:t,foeColor:d?r?"blue":"#a00":r?"#75f":"#f0a",horseFrame:Math.floor(Math.random()*100),goal:[a,s],gdist:0,ax:e=>(e.goal[0]-c.x)/2e3,ay:e=>(e.goal[1]-c.y)/2e3,x:a,y:s,rangeOverride:e=>!I(e.moving,e)?[0]:r?[0,4]:[0,3],speed:()=>l*u,archerOrientation:e=>Math.sign(I(e.dx,e)),cache:true,soldier:r,process:o=>{if(!o.parent||!I(o.active,o)){return}if(o.dead&&o.time-o.dead>5e3){o.dead=0;o.speed=o.soldier?Math.max(.025,Math.random()/30):Math.max(.03,Math.random()/20)}he(fe,o);const e=o.x-o.goal[0];const t=o.y-o.goal[1];o.gdist=Math.sqrt(e*e+t*t);const n=o.x-F.x;const i=o.y-F.y;const r=Math.sqrt(n*n+i*i);if(r<50&&!o.dead&&y){if(ce(F)){F.lastBlock=F.time}else{h.backgroundColor="#a00";y=Math.max(0,y-(d?2:1));L()}b=40;setTimeout(()=>{h.backgroundColor="#efd"},150);ve();const e=Math.random()*Math.PI*2;const t=Math.cos(e);const n=Math.sin(e);o.x=F.x+t*2e3;o.y=F.y+n*2e3;F.dx=0;F.dy=0;F.hitTime=F.time}if(Le||!y){if(!o.pausing){o.pausing=true;const a=o.x-(Le??F).x;const s=o.y-(Le??F).y;const l=Math.sqrt(a*a+s*s);o.goal[0]=F.x+a/l*2e3;o.goal[1]=F.y+s/l*2e3}}else{if(o.pausing){o.pausing=false}if(r>2500){if(Math.random()<.6||!F.dx&&!F.dy){const e=Math.random()*Math.PI*2;const t=Math.cos(e);const n=Math.sin(e);o.x=F.x+t*1500;o.y=F.y+n*1500}else{const c=Math.sqrt(F.dx*F.dx+F.dy*F.dy);o.x=F.x+F.dx*(1e3+Math.random()*500)/c+(Math.random()-.5)*300;o.y=F.y+F.dy*(1e3+Math.random()*500)/c+(Math.random()-.5)*300}if(o.dead){o.dead=0;o.speed=o.soldier?Math.max(.025,Math.random()/30):Math.max(.03,Math.random()/20)}o.gdist=0}if(o.gdist<100||r>(o.soldier?500:3e3)){o.goal[0]=F.x+(F.x-o.x)+(Math.random()-.5)*(o.soldier?200:300);o.goal[1]=F.y+(F.y-o.y)+(Math.random()-.5)*(o.soldier?200:300)}}},foe:true,width:(r?200*f:220*f)*(d?r?2:1.5:1),height:(r?180*f:180*f)*(d?r?2:1.5:1),riderAnimation:r?"soldier":"sword"};return c});function $e(e){return e.cost?.length&&E>=e.cost[0]*d}const l=document.body.appendChild(document.createElement("div"));l.style.position="absolute";l.style.left="200px";l.style.top="200px";l.style.display="none";const Ae=new Array(5).fill(null).map(()=>{const e=l.appendChild(document.createElement("div"));e.style.backgroundColor="#444";e.style.margin="20px 10px";e.style.padding="10px";return e});const Ce=Ae.map(()=>null);let c=0;let Te=[];function Ee(t){if(!t){c=0;a.sort((e,t)=>{if(e.name==="bow"){return-1}else if(t.name==="bow"){return 1}return Math.random()-.5});Te=[...a].filter($e).slice(0,Ae.length-1)}const n=Te;l.style.display="";for(let e=0;e<Ae.length;e++){if(!t){Ce[e]=false}const o=Ae[e];o.style.backgroundColor=Ce[e]?"#6F6":e===c?"#480":"#222";o.style.outline=e===c?"4px solid green":"";o.style.display=e>n.length-(!T.bow?1:0)?"none":"";o.innerText=e===n.length?"Exit":!n[e]?"":`${n[e].title} ${Ce[e]?"✔️":!n[e].cost[0]?"":`(Cost: ${n[e].cost[0]*d} 🏵️)`}\n${I(n[e].description,n[e])}`}}let Le=null;let R=null;const Oe={};const qe=200;const Pe=new Array(qe).fill(0).map((e,t)=>{const i=t<=1;const r=i?18e3:4e3;const a=r/2+500;const n={...M(P),cache:true,x:i?t*r:1e3+Math.random()*4e3,y:i?t*r/2:Math.random()*4e3,cellX:0,cellY:0,index:t,process:e=>{if(!e.parent||!I(e.active,e)){return}const t=e.x-F.x;const n=e.y-F.y;const o=Math.sqrt(t*t+n*n);if(o<(i?80:50)){if(i&&!B(e).closed){if(!R){R=e;e.enteredHut=e.time;if(!B(R).level){B(R).level=He++;ue=K[Math.min(He,K.length-1)]?.()}L();s.stop();Ee()}}else{b=20;F.x-=t;F.y-=n;F.dx*=T.treeNav*.3;F.dy*=T.treeNav*.3}}if(t>a*2){e.x-=r*2;e.cellX--}else if(t<-a*2){e.x+=r*2;e.cellX++}if(n>a){e.y-=r;e.cellY--}else if(n<-a){e.y+=r;e.cellY++}},foe:true,width:(i?600:500)*f,height:(i?400:350+Math.random()*200)*f,riderAnimation:i?"hut":"tree",foeColor:i?`rgb(${200}, ${100+t*55}, ${50+t*50})`:`rgb(${Math.random()*30}, ${Math.random()*150}, ${Math.random()*20})`,tree:true,hut:i,rangeOverride:i?[1]:undefined};return n});function Ie(){U=_();Fe.x=F.x;Fe.y=F.y;s=j}window.findBorte=Ie;let Fe={...P,borte:true,foeColor:"red",active:()=>U,shootPeriod:1e3,process:e=>{if(!e.parent||!I(e.active,e)){return}const t=F.x-e.x;const n=F.y-e.y;const o=Math.sqrt(t*t+n*n);if(o>300){e.ax=t*.01;e.ay=n*.01}else{e.ax=0;e.ay=0}if(e.time>e.nextShot){de(e);e.nextShot=e.time+I(e.shootPeriod,e)}he(fe,e);e.orientation=Math.sign(e.dx??1)*2},archerOrientation:e=>Math.sign(e.dx||1)};let He=0;function B(e){const t=`${e.cellX}_${e.cellY}_${e.index}`;return Oe[t]??(Oe[t]={})}function Re(e,t){const n=e.x-t.x;const o=e.y-t.y;return n*n+o*o}function Be(){const t=Pe.filter(e=>e.hut&&!B(e).closed);let n=t[0];for(let e=1;e<t.length;e++){if(Re(t[e],F)<Re(n,F)){n=t[e]}}return n}const je=[[F,Fe],Se,be,Pe];let v=null;let k;function De(t){requestAnimationFrame(De);x=Math.max(x,t-100);if(g){return}k=t-x;x=t;if(b){H=Math.random()*b;b*=.5;if(b<.1){b=0}}$.clearRect(0,0,A.width,A.height);he(We,q);$.beginPath();$.strokeStyle="#038";$.lineWidth=6;const e=.7;for(let e=0;e<O;e++){const o=q[e];const i=50;const r=Math.sqrt(o.dx*o.dx+o.dy*o.dy)+1;$.moveTo(o.x-C[0],o.y-C[1]+H);$.lineTo(o.x-C[0]-o.dx/r*i,o.y-C[1]+H-o.dy/r*i)}$.stroke();for(let e=O-1;e>=0;e--){if(t-q[e].born>1500){le(e)}}$.strokeStyle="#380";$.lineWidth=2;m.length=0;Ke(m);je.forEach(e=>e.forEach(e=>ye(e,t,k,m)));m.sort((e,t)=>{if(e.layer!==t.layer){return e.layer-t.layer}return Math.sign(e.y-t.y)});Le=null;m.forEach(e=>xe(e,t));const n=Be();if(n){const a=n.x-F.x;const s=n.y-F.y;const l=Math.sqrt(a*a+s*s);if(l>2e3){if(!v){v=[F.x,F.y]}$.beginPath();const c=2e3;const d=F.x+a/l*c-C[0];const h=F.y+s/l*c-C[1];v[0]+=(d-v[0])*.1;v[1]+=(h-v[1])*.1;$.arc(Math.min(A.width-80,Math.max(80,v[0])),Math.min(A.height-80,Math.max(80,v[1])),15,0,2*Math.PI);$.fill()}}if(!y){const f=Math.min(.7,(t-F.dead)/3e3);$.fillStyle=`rgb(200,0,0,${f})`;$.fillRect(0,0,A.width,A.height);$.fill()}else if(!R){if(!p){Me+=((F.dx*F.archerOrientation<0?0:F.dx)/2+F.archerOrientation-Me)*.05;const k=20;C[0]+=k/20*(F.x-A.width/2-C[0]+Me*80)*.1;C[1]+=k/20*(F.y-A.height/2-C[1]+F.dy*50)*.1}else{C[0]=-A.width/2;C[1]=-A.height/2}}else{const u=Math.min(1,(t-R.enteredHut)/500);$.fillStyle=`rgb(0,0,0,${u})`;$.fillRect(0,0,A.width,A.height);$.fill()}}function We(t){const n=.4;const o=50;for(let e=0;e<O;e++){const i=t[e];const r=Math.sqrt(i.dx*i.dx+i.dy*i.dy)+1;i.dy+=.3;i.x+=i.dx/r*o*n;i.y+=i.dy/r*o*n}}function Ke(){const n=200;$.beginPath();const o=[Math.round(C[0]/n),Math.round(C[1]/n)];for(let t=-15;t<15;t++){for(let e=-20;e<20;e++){const i=e+o[0];const r=t+o[1];const a=Math.sin(i*123+r*9991)+Math.sin(i*123/10+r*9991/100)+Math.sin(i*123/10+r*9991/100);const s=Math.cos(i*12331+r*2221)+Math.cos(i*12331/10+r*2221/10)+Math.cos(i*12331/100+r*2221/100);const l=a*500;const c=s*200;const d=i*n-C[0]+l;const h=r*n-C[1]+c;$.moveTo(d,h+H);$.lineTo(d+a*100,h+H+3);$.lineTo(d+a*100+s*100,h+H)}}$.stroke()}te()},3e3)});